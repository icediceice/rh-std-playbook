---
- name: Enable Packet Capture on Fortinet VA
  hosts: "{{ target_hosts }}"
  gather_facts: no
  connection: httpapi
  become: no
  vars:
    ansible_network_os: fortinet.fortios.fortios
    ansible_httpapi_use_ssl: true
    ansible_httpapi_validate_certs: false
    ansible_httpapi_port: 443
    vpn_name: "{{ vpn_name | default('vpn1') }}"
    filter: "{{ capture_filter | default('') }}"
    vdom: "{{ vdom | default('root') }}"
  tasks:
    - name: Get VPN Phase 2 interfaces for the VPN
      fortinet.fortios.fortios_monitor_fact:
        vdom: "{{ vdom }}"
        selector: 'vpn_ipsec_stats_crypto'
        access_token: "{{ ansible_password | default(fortinet_api_token) }}"
      register: vpn_phase2

    - name: Set list of interfaces related to the VPN
      set_fact:
        vpn_interfaces: >-
          {{ vpn_phase2.meta.results | selectattr('name', 'search', vpn_name) | map(attribute='interface') | list | unique }}

    - name: Start packet capture on each related interface
      fortinet.fortios.fortios_system_sniffer:
        state: "present"
        vdom: "{{ vdom }}"
        access_token: "{{ ansible_password | default(fortinet_api_token) }}"
        system_sniffer:
          name: "capture_{{ item }}_{{ ansible_date_time.epoch }}"
          interface: "{{ item }}"
          host: "{{ filter }}"
      loop: "{{ vpn_interfaces }}"
      register: capture_result

    - name: Show packet capture result
      debug:
        var: capture_result
