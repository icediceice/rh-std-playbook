---
# Working Connection Test for Fortinet
# Based on the working connect_fortinet.yml approach

- name: Test Fortinet Device Connection
  hosts: "{{ target_hosts }}"
  gather_facts: no
  connection: httpapi
  become: no
  
  tasks:
    - name: Test basic network connectivity
      wait_for:
        host: "{{ hostvars[inventory_hostname]['ansible_host'] }}"
        port: 443
        timeout: 10
      delegate_to: localhost
      vars:
        ansible_connection: local
      register: network_test
      ignore_errors: yes
      
    - name: Test FortiGate authentication  
      fortinet.fortios.fortios_monitor_fact:
        vdom: "{{ vdom | default('root') }}"
        formatters:
          - selector: 'system_status'
      register: auth_test
      ignore_errors: yes
      when: network_test is succeeded
      
    - name: Display results
      debug:
        msg:
          - "==============================="
          - "Fortinet Connection Test Results"
          - "==============================="
          - "Device: {{ inventory_hostname }}"
          - "IP: {{ ansible_host | default('Not configured') }}"
          - "User: {{ ansible_user }}"
          - ""
          - "Network: {{ 'REACHABLE' if network_test is succeeded else 'UNREACHABLE' }}"
          - "Auth: {{ 'SUCCESS' if auth_test is succeeded else 'FAILED' if network_test is succeeded else 'NOT TESTED' }}"
          - ""
          - "Overall: {{ 'WORKING' if (network_test is succeeded and auth_test is succeeded) else 'FAILED' }}"
          
    - name: Show error details
      debug:
        msg:
          - "Network Error: {{ network_test.msg | default('N/A') }}"
          - "Auth Error: {{ auth_test.msg | default('N/A') if auth_test is defined else 'Not tested due to network failure' }}"
      when: network_test is failed or (auth_test is defined and auth_test is failed)