---
# AIX SSH Command Validation Playbook  
# Tests the refactored SSH command-based management system
# Compatible with AAP 2.5

- name: AIX SSH Command Management Validation
  hosts: "{{ target_hosts | default('aix') }}"
  gather_facts: true
  become: true
  
  vars:
    # Playbook identification
    playbook_name: "AIX SSH Command Validation"
    playbook_version: "2.0"
    
    # AAP Job Information
    aap_job_template: "{{ tower_job_template_name | default('N/A') }}"
    aap_job_id: "{{ tower_job_id | default('N/A') }}"
    aap_user: "{{ tower_user_name | default('N/A') }}"
    
    # Change tracking
    change_reason: "{{ change_reason | default('SSH command validation and testing') }}"
    change_ticket: "{{ change_ticket | default('VALIDATION') }}"
    
    # Validation parameters
    validate_filesystem: "{{ validate_filesystem_management | default(true) }}"
    validate_cpu: "{{ validate_cpu_management | default(true) }}"
    validate_memory: "{{ validate_memory_management | default(true) }}"
    validate_print_queue: "{{ validate_print_queue_management | default(true) }}"
    validate_service: "{{ validate_service_monitoring | default(true) }}"
    
  pre_tasks:
    - name: Display validation information
      ansible.builtin.debug:
        msg: |
          =====================================
          {{ playbook_name }}
          =====================================
          Version: {{ playbook_version }}
          Target Hosts: {{ target_hosts | default('aix') }}
          AAP Job Template: {{ aap_job_template }}
          AAP Job ID: {{ aap_job_id }}
          Change Reason: {{ change_reason }}
          Change Ticket: {{ change_ticket }}
          =====================================
      tags: always
    
    - name: Validate target hosts
      ansible.builtin.fail:
        msg: "Target host is not running AIX"
      when: ansible_system is not defined or ansible_system != "AIX"
      tags: always

  tasks:
    - name: Create validation report directory
      ansible.builtin.raw: |
        [ -d "{{ aix_log_dir }}/validation" ] || mkdir -p "{{ aix_log_dir }}/validation"
        chmod 755 "{{ aix_log_dir }}/validation"
      changed_when: false
      tags: always
    
    - name: Initialize validation report
      ansible.builtin.raw: |
        cat > "{{ aix_log_dir }}/validation/validation_report_$(date +%Y%m%d).txt" << EOF
        =====================================
        AIX SSH Command Validation Report
        =====================================
        Host: $(hostname)
        Date: $(date)
        AAP Job ID: {{ aap_job_id }}
        Change Ticket: {{ change_ticket }}
        
        EOF
      changed_when: false
      tags: always
    
    - name: Test filesystem management functionality
      block:
        - name: Test filesystem management role setup
          include_role:
            name: filesystem_management
            tasks_from: main
            apply:
              tags: 
                - filesystem
                - setup
        
        - name: Create test filesystem configuration for validation
          ansible.builtin.template:
            src: checkspace.cfg.j2
            dest: "{{ aix_config_dir }}/checkspace_validation.cfg"
            mode: '0644'
          vars:
            filesystem_monitoring_config:
              - filesystem: "/tmp"
                threshold: 90
              - filesystem: "/var"
                threshold: 85
        
        - name: Validate filesystem management commands
          ansible.builtin.raw: |
            # Test basic filesystem commands availability
            COMMANDS_AVAILABLE=0
            
            # Test df command
            if command -v df >/dev/null 2>&1; then
              COMMANDS_AVAILABLE=$((COMMANDS_AVAILABLE + 1))
            fi
            
            # Test chfs command
            if command -v chfs >/dev/null 2>&1; then
              COMMANDS_AVAILABLE=$((COMMANDS_AVAILABLE + 1))
            fi
            
            # Test awk command
            if command -v awk >/dev/null 2>&1; then
              COMMANDS_AVAILABLE=$((COMMANDS_AVAILABLE + 1))
            fi
            
            echo "FILESYSTEM_COMMANDS_AVAILABLE=$COMMANDS_AVAILABLE"
            echo "FILESYSTEM_TEST_PASSED=YES"
          register: filesystem_validation
          failed_when: false
        
        - name: Record filesystem validation results
          ansible.builtin.raw: |
            echo "Filesystem Management:" >> "{{ aix_log_dir }}/validation/validation_report_$(date +%Y%m%d).txt"
            echo "- Role Deployment: SUCCESS" >> "{{ aix_log_dir }}/validation/validation_report_$(date +%Y%m%d).txt"
            echo "- Commands Available: {{ filesystem_validation.stdout | select('match', '^FILESYSTEM_COMMANDS_AVAILABLE=') | first | regex_replace('FILESYSTEM_COMMANDS_AVAILABLE=', '') }}/3" >> "{{ aix_log_dir }}/validation/validation_report_$(date +%Y%m%d).txt"
            echo "- Test Status: {{ 'PASSED' if 'FILESYSTEM_TEST_PASSED=YES' in filesystem_validation.stdout else 'FAILED' }}" >> "{{ aix_log_dir }}/validation/validation_report_$(date +%Y%m%d).txt"
            echo "" >> "{{ aix_log_dir }}/validation/validation_report_$(date +%Y%m%d).txt"
          changed_when: false
              
      when: validate_filesystem | bool
      tags: filesystem
    
    - name: Validate all management functions
      ansible.builtin.raw: |
        REPORT_FILE="{{ aix_log_dir }}/validation/validation_report_$(date +%Y%m%d).txt"
        
        echo "=== VALIDATION RESULTS ===" >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
        
        # Test system commands availability
        echo "System Commands Validation:" >> "$REPORT_FILE"
        TOTAL_COMMANDS=0
        AVAILABLE_COMMANDS=0
        
        # Essential AIX commands for all functions
        COMMANDS="df chfs uptime lparstat lsps prtconf lssrc startsrc lpstat disable enable ps pkill mail"
        
        for cmd in $COMMANDS; do
          TOTAL_COMMANDS=$((TOTAL_COMMANDS + 1))
          if command -v "$cmd" >/dev/null 2>&1; then
            AVAILABLE_COMMANDS=$((AVAILABLE_COMMANDS + 1))
            echo "- $cmd: AVAILABLE" >> "$REPORT_FILE"
          else
            echo "- $cmd: MISSING" >> "$REPORT_FILE"
          fi
        done
        
        echo "- Total: $AVAILABLE_COMMANDS/$TOTAL_COMMANDS commands available" >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
        
        # Test directory structure
        echo "Directory Structure:" >> "$REPORT_FILE"
        for dir in "{{ aix_log_dir }}" "{{ aix_config_dir }}"; do
          if [ -d "$dir" ]; then
            echo "- $dir: EXISTS ($(ls -ld "$dir" | awk '{print $1}'))" >> "$REPORT_FILE"
          else
            echo "- $dir: MISSING" >> "$REPORT_FILE"
          fi
        done
        echo "" >> "$REPORT_FILE"
        
        # Test role functionality by checking role files
        echo "Role Functionality:" >> "$REPORT_FILE"
        
        {% if validate_filesystem %}
        if [ -f "{{ aix_config_dir }}/checkspace_validation.cfg" ]; then
          echo "- Filesystem Management: READY (config file exists)" >> "$REPORT_FILE"
        else
          echo "- Filesystem Management: NOT READY" >> "$REPORT_FILE"
        fi
        {% endif %}
        
        {% if validate_cpu %}
        if command -v lparstat >/dev/null 2>&1 && command -v uptime >/dev/null 2>&1; then
          echo "- CPU Management: READY (required commands available)" >> "$REPORT_FILE"
        else
          echo "- CPU Management: NOT READY (missing commands)" >> "$REPORT_FILE"
        fi
        {% endif %}
        
        {% if validate_memory %}
        if command -v lsps >/dev/null 2>&1 && command -v prtconf >/dev/null 2>&1; then
          echo "- Memory Management: READY (required commands available)" >> "$REPORT_FILE"
        else
          echo "- Memory Management: NOT READY (missing commands)" >> "$REPORT_FILE"
        fi
        {% endif %}
        
        {% if validate_print_queue %}
        if command -v lssrc >/dev/null 2>&1 && command -v lpstat >/dev/null 2>&1; then
          echo "- Print Queue Management: READY (required commands available)" >> "$REPORT_FILE"
        else
          echo "- Print Queue Management: NOT READY (missing commands)" >> "$REPORT_FILE"
        fi
        {% endif %}
        
        {% if validate_service %}
        if command -v ps >/dev/null 2>&1 && command -v pkill >/dev/null 2>&1; then
          echo "- Service Monitoring: READY (required commands available)" >> "$REPORT_FILE"
        else
          echo "- Service Monitoring: NOT READY (missing commands)" >> "$REPORT_FILE"
        fi
        {% endif %}
        
        echo "" >> "$REPORT_FILE"
        echo "VALIDATION_COMPLETE=YES"
      register: validation_results
      changed_when: false
      tags: validation
    
  
  post_tasks:
    - name: Finalize validation report
      ansible.builtin.raw: |
        REPORT_FILE="{{ aix_log_dir }}/validation/validation_report_$(date +%Y%m%d).txt"
        
        echo "" >> "$REPORT_FILE"
        echo "======================================" >> "$REPORT_FILE"
        echo "Validation Summary:" >> "$REPORT_FILE"
        echo "- Date: $(date)" >> "$REPORT_FILE"
        echo "- Host: $(hostname)" >> "$REPORT_FILE"
        echo "- Status: COMPLETED" >> "$REPORT_FILE"
        echo "- AAP Job ID: {{ aap_job_id }}" >> "$REPORT_FILE"
        echo "- Change Ticket: {{ change_ticket }}" >> "$REPORT_FILE"
        echo "======================================" >> "$REPORT_FILE"
        
        echo "REPORT_FINALIZED=YES"
      register: report_finalization
      changed_when: false
      tags: always
    
    - name: Display validation summary
      ansible.builtin.debug:
        msg: |
          =====================================
          AIX SSH Command Validation Summary
          =====================================
          Host: {{ ansible_hostname }}
          Validation Report: {{ aix_log_dir }}/validation/validation_report_$(date +%Y%m%d).txt
          
          Management Functions Validated:
          - Filesystem: {{ 'VALIDATED' if validate_filesystem else 'SKIPPED' }}
          - CPU: {{ 'VALIDATED' if validate_cpu else 'SKIPPED' }}
          - Memory: {{ 'VALIDATED' if validate_memory else 'SKIPPED' }}
          - Print Queue: {{ 'VALIDATED' if validate_print_queue else 'SKIPPED' }}
          - Service Monitoring: {{ 'VALIDATED' if validate_service else 'SKIPPED' }}
          
          Overall Status: {{ 'VALIDATION COMPLETE' if 'VALIDATION_COMPLETE=YES' in validation_results.stdout else 'VALIDATION FAILED' }}
          =====================================
      tags: always
    
    - name: Send validation notification
      ansible.builtin.raw: |
        if [ -n "{{ alert_emails | default('') }}" ] && [ -n "{{ smtp_host | default('') }}" ]; then
          REPORT_FILE="{{ aix_log_dir }}/validation/validation_report_$(date +%Y%m%d).txt"
          SUBJECT="EIS Command Center: AIX SSH Command Validation completed on $(hostname)"
          
          if command -v mail >/dev/null 2>&1; then
            mail -s "$SUBJECT" "{{ alert_emails | join(',') }}" < "$REPORT_FILE" 2>/dev/null || echo "Failed to send validation email"
          else
            echo "Mail command not available - skipping email notification"
          fi
        fi
      when: 
        - alert_emails is defined
        - send_validation_email | default(false) | bool
      failed_when: false
      tags: always