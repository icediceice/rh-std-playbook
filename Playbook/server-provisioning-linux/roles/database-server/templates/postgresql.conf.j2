# PostgreSQL configuration for {{ server_hostname }}
# Environment: {{ server_environment }}
# Generated by Ansible

#------------------------------------------------------------------------------
# FILE LOCATIONS
#------------------------------------------------------------------------------

data_directory = '{{ postgresql_data_dir }}'
hba_file = '{{ postgresql_data_dir }}/pg_hba.conf'
ident_file = '{{ postgresql_data_dir }}/pg_ident.conf'
external_pid_file = '/var/run/postgresql/{{ postgresql_version }}-main.pid'

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

listen_addresses = '*'
port = {{ postgresql_port }}
max_connections = {{ postgresql_max_connections }}

#------------------------------------------------------------------------------
# RESOURCE USAGE
#------------------------------------------------------------------------------

{% if server_environment == 'production' %}
shared_buffers = 512MB
effective_cache_size = 2GB
maintenance_work_mem = 128MB
work_mem = 8MB
{% elif server_environment == 'staging' %}
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
work_mem = 4MB
{% else %}
shared_buffers = 128MB
effective_cache_size = 512MB
maintenance_work_mem = 32MB
work_mem = 2MB
{% endif %}

#------------------------------------------------------------------------------
# WRITE AHEAD LOG
#------------------------------------------------------------------------------

wal_level = replica
max_wal_size = 1GB
min_wal_size = 80MB
archive_mode = {{ 'on' if enable_backups else 'off' }}
{% if enable_backups %}
archive_command = 'cp %p /var/backups/postgresql/archive/%f'
{% endif %}

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

random_page_cost = 1.1
effective_io_concurrency = 200
default_statistics_target = 100

#------------------------------------------------------------------------------
# REPORTING AND LOGGING
#------------------------------------------------------------------------------

logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 1GB
log_line_prefix = '%m [%p] %u@%d '
log_timezone = '{{ server_timezone }}'

{% if server_environment == 'production' %}
log_min_duration_statement = 1000  # Log slow queries
log_checkpoints = on
log_connections = on
log_disconnections = on
{% endif %}

#------------------------------------------------------------------------------
# STATISTICS
#------------------------------------------------------------------------------

track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
track_activity_query_size = 1024

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

datestyle = 'iso, mdy'
timezone = '{{ server_timezone }}'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'