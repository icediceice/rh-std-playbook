# Chrony configuration for {{ server_hostname }}
# Environment: {{ server_environment }}
# Generated by Ansible

# Use public servers from the pool.ntp.org project.
{% for server in ntp_servers | default(['0.rhel.pool.ntp.org', '1.rhel.pool.ntp.org', '2.rhel.pool.ntp.org']) %}
server {{ server }} iburst
{% endfor %}

# Record the rate at which the system clock gains/losses time.
driftfile /var/lib/chrony/drift

# Allow the system clock to be stepped in the first three updates
# if its offset is larger than 1 second.
makestep 1.0 3

# Enable kernel synchronization of the real-time clock (RTC).
rtcsync

# Specify directory for log files.
logdir /var/log/chrony

# Select which information is logged.
{% if server_environment == 'production' %}
log measurements statistics tracking
{% else %}
log tracking
{% endif %}

# Stop bad estimates upsetting machine clock.
maxupdateskew 100.0

# This directive enables kernel RTC synchronization.
rtcsync

{% if server_environment == 'production' %}
# Dump measurements when daemon exits.
dumponexit

# Specify directory for dumping measurements.
dumpdir /var/lib/chrony
{% endif %}

# Allow NTP client access from local network.
{% if server_role == 'logging' %}
# Logging server acts as NTP server for other nodes
allow 192.168.0.0/16
allow 10.0.0.0/8
allow 172.16.0.0/12
{% else %}
# Only allow localhost
allow 127.0.0.1
{% endif %}

# Serve time even if not synchronized to a time source.
local stratum 10

# Require authentication for NTP clients (production only)
{% if server_environment == 'production' %}
# Require authentication (nts)
# ntsservercert /etc/pki/tls/certs/{{ server_hostname }}.crt
# ntsserverkey /etc/pki/tls/private/{{ server_hostname }}.key
{% endif %}